local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer

local function getPlayerPlot(player)
    local plots = Workspace:FindFirstChild("Plots")
    if plots and plots:FindFirstChild(player.Name) then
        return plots[player.Name]
    end

    if Workspace:FindFirstChild(player.Name) then
        return Workspace[player.Name]
    end

    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Folder") or obj:IsA("Model") then
            local owner = obj:FindFirstChild("Owner")
            if owner and owner.Value == player then
                return obj
            end
        end
    end

    return nil
end

local function exportBuild()
    local plotFolder = getPlayerPlot(LocalPlayer)
    if not plotFolder then return end

    local blocks = {}
    local idToName = {}

    local minX, minY, minZ = math.huge, math.huge, math.huge
    local maxX, maxY, maxZ = -math.huge, -math.huge, -math.huge

    local function processPart(part)
        if not part:IsA("Part") then return end

        local x = math.floor(part.Position.X)
        local y = math.floor(part.Position.Y)
        local z = math.floor(part.Position.Z)

        minX = math.min(minX, x)
        minY = math.min(minY, y)
        minZ = math.min(minZ, z)

        maxX = math.max(maxX, x)
        maxY = math.max(maxY, y)
        maxZ = math.max(maxZ, z)

        local id = #idToName + 1
        idToName[id] = part.Name

        local motors = {}
        for _, m in ipairs(part:GetChildren()) do
            if m:IsA("Motor6D") or m:IsA("HingeConstraint") then
                table.insert(motors, {
                    ClassName = m.ClassName,
                    Name = m.Name,
                    Enabled = m.Enabled
                })
            end
        end

        local keybinds = {}
        for _, v in ipairs(part:GetChildren()) do
            if v:IsA("IntValue") or v:IsA("BoolValue") then
                keybinds[v.Name] = v.Value
            end
        end

        table.insert(blocks, {
            x = x,
            y = y,
            z = z,
            size = {part.Size.X, part.Size.Y, part.Size.Z},
            rotation = {part.Orientation.X, part.Orientation.Y, part.Orientation.Z},
            color = {part.Color.R, part.Color.G, part.Color.B},
            anchored = part.Anchored,
            id = id,
            motors = motors,
            keybinds = keybinds
        })
    end

    for _, obj in ipairs(plotFolder:GetDescendants()) do
        processPart(obj)
    end

    if #blocks == 0 then return end

    for _, b in ipairs(blocks) do
        b.x -= minX
        b.y -= minY
        b.z -= minZ
    end

    local pcbuild = {
        version = 1,
        width = maxX - minX + 1,
        height = maxY - minY + 1,
        length = maxZ - minZ + 1,
        palette = idToName,
        blocks = blocks,
        metadata = {
            name = "Exported Build " .. os.date("%Y-%m-%d"),
            author = LocalPlayer.Name
        }
    }

    local json = HttpService:JSONEncode(pcbuild)

    if setclipboard then
        setclipboard(json)
    end
end

local function importBuild(json)
    local success, pcbuild = pcall(function()
        return HttpService:JSONDecode(json)
    end)

    if not success then return end

    local buildFolder = Instance.new("Folder")
    buildFolder.Name = pcbuild.metadata and pcbuild.metadata.name or "ImportedBuild"
    buildFolder.Parent = Workspace

    local idToName = pcbuild.palette or {}

    for _, b in ipairs(pcbuild.blocks or {}) do
        local part = Instance.new("Part")
        part.Name = idToName[b.id] or "Unknown"
        part.Size = Vector3.new(unpack(b.size))
        part.Position = Vector3.new(b.x + 0.5, b.y + 0.5, b.z + 0.5)
        part.Color = Color3.new(unpack(b.color))
        part.Anchored = b.anchored
        part.Orientation = Vector3.new(unpack(b.rotation))
        part.Parent = buildFolder

        for k, v in pairs(b.keybinds or {}) do
            local valueObj
            if typeof(v) == "boolean" then
                valueObj = Instance.new("BoolValue")
            else
                valueObj = Instance.new("IntValue")
            end
            valueObj.Name = k
            valueObj.Value = v
            valueObj.Parent = part
        end

        for _, m in ipairs(b.motors or {}) do
            local newMotor = Instance.new(m.ClassName)
            newMotor.Name = m.Name
            if m.Enabled ~= nil then
                newMotor.Enabled = m.Enabled
            end
            newMotor.Parent = part
        end
    end
end

if CoreGui:FindFirstChild("PlaneCrazyUltimateGUI") then
    CoreGui.PlaneCrazyUltimateGUI:Destroy()
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PlaneCrazyUltimateGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = CoreGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 400, 0, 200)
frame.Position = UDim2.new(0.5, -200, 0.5, -100)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local exportBtn = Instance.new("TextButton")
exportBtn.Size = UDim2.new(0, 160, 0, 50)
exportBtn.Position = UDim2.new(0, 20, 0, 20)
exportBtn.Text = "Export Build"
exportBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
exportBtn.TextColor3 = Color3.new(1, 1, 1)
exportBtn.Parent = frame

local importBtn = Instance.new("TextButton")
importBtn.Size = UDim2.new(0, 160, 0, 50)
importBtn.Position = UDim2.new(0, 20, 0, 90)
importBtn.Text = "Import Build"
importBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
importBtn.TextColor3 = Color3.new(1, 1, 1)
importBtn.Parent = frame

exportBtn.MouseButton1Click:Connect(exportBuild)

importBtn.MouseButton1Click:Connect(function()
    if getclipboard then
        importBuild(getclipboard())
    end
end)

print("Plane Crazy Ultimate Export/Import GUI loaded.")

